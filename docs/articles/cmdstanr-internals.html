<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How does CmdStanR work? • cmdstanr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How does CmdStanR work?">
<meta property="og:description" content="cmdstanr">
<meta property="og:image" content="https://mc-stan.org/cmdstanr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cmdstanr</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9006</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://mc-stan.org/rstan">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="https://mc-stan.org/bayesplot">bayesplot</a>
    </li>
    <li>
      <a href="https://mc-stan.org/shinystan">shinystan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/loo">loo</a>
    </li>
    <li>
      <a href="https://mc-stan.org/projpred">projpred</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstantools">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://mc-stan.org">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/cmdstanr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://discourse.mc-stan.org/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How does CmdStanR work?</h1>
                        <h4 class="author">Jonah Gabry and Rok Češnovar</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/cmdstanr/blob/master/vignettes/cmdstanr-internals.Rmd"><code>vignettes/cmdstanr-internals.Rmd</code></a></small>
      <div class="hidden name"><code>cmdstanr-internals.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This vignette is intended to be read after the <a href="http://mc-stan.org/cmdstanr/articles/cmdstanr.html"><em>Getting started with CmdStanR</em></a> vignette. Please read that first for important background. In this document we provide additional details about compiling models, passing in data, and how CmdStan output is saved and read back into R.</p>
<p>We will only use the <code>$sample()</code> method in examples, but all model fitting methods work in a similar way under the hood.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">cmdstanr</span>)</pre></body></html></div>
</div>
<div id="compilation" class="section level2">
<h2 class="hasAnchor">
<a href="#compilation" class="anchor"></a>Compilation</h2>
<div id="immediate-compilation" class="section level3">
<h3 class="hasAnchor">
<a href="#immediate-compilation" class="anchor"></a>Immediate compilation</h3>
<p>The <code><a href="../reference/cmdstan_model.html">cmdstan_model()</a></code> function creates a new <code>CmdStanModel</code> object. The <code>CmdStanModel</code> object stores the path to a Stan program as well as the path to a compiled executable:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">stan_file</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="../reference/set_cmdstan_path.html">cmdstan_path</a></span>(), <span class="st">"examples"</span>, <span class="st">"bernoulli"</span>, <span class="st">"bernoulli.stan"</span>)
<span class="no">mod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cmdstan_model.html">cmdstan_model</a></span>(<span class="no">stan_file</span>)</pre></body></html></div>
<pre><code>Compiling Stan program...</code></pre>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">mod</span>$<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>()</pre></body></html></div>
<pre><code>data { 
  int&lt;lower=0&gt; N; 
  int&lt;lower=0,upper=1&gt; y[N];
} 
parameters {
  real&lt;lower=0,upper=1&gt; theta;
} 
model {
  theta ~ beta(1,1);  // uniform prior on interval 0,1
  y ~ bernoulli(theta);
}</code></pre>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">mod</span>$<span class="fu">stan_file</span>()</pre></body></html></div>
<pre><code>[1] "/Users/jgabry/.cmdstanr/cmdstan-2.23.0/examples/bernoulli/bernoulli.stan"</code></pre>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">mod</span>$<span class="fu">exe_file</span>()</pre></body></html></div>
<pre><code>[1] "/Users/jgabry/.cmdstanr/cmdstan-2.23.0/examples/bernoulli/bernoulli"</code></pre>
<p>Subsequently, if you create a <code>CmdStanModel</code> object from the same Stan file then compilation will be skipped (assuming the file hasn’t changed):</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">mod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cmdstan_model.html">cmdstan_model</a></span>(<span class="no">stan_file</span>)</pre></body></html></div>
<pre><code>Model executable is up to date!</code></pre>
<p>Internally, <code><a href="../reference/cmdstan_model.html">cmdstan_model()</a></code> first creates the <code>CmdStanModel</code> object from just the Stan file and then calls its <a href="http://mc-stan.org/cmdstanr/reference/model-method-compile.html"><code>$compile()</code></a> method. Optional arguments to the <code>$compile()</code> method can be passed via <code>...</code>, for example:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">mod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cmdstan_model.html">cmdstan_model</a></span>(
  <span class="no">stan_file</span>,
  <span class="kw">force_recompile</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
  <span class="kw">include_paths</span> <span class="kw">=</span> <span class="st">"paths/to/directories/with/included/files"</span>,
  <span class="kw">cpp_options</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">stan_threads</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">STANC2</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
)</pre></body></html></div>
</div>
<div id="delayed-compilation" class="section level3">
<h3 class="hasAnchor">
<a href="#delayed-compilation" class="anchor"></a>Delayed compilation</h3>
<p>It is also possible to delay compilation when creating the <code>CmdStanModel</code> object by specifying <code>compile=FALSE</code>. You can later call the <code>$compile()</code> method directly:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span>(<span class="no">mod</span>$<span class="fu">exe_file</span>())
<span class="no">mod</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cmdstan_model.html">cmdstan_model</a></span>(<span class="no">stan_file</span>, <span class="kw">compile</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">mod</span>$<span class="fu">exe_file</span>() <span class="co"># not yet created</span></pre></body></html></div>
<pre><code><a href="https://rdrr.io/r/base/character.html">character(0)</a></code></pre>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">mod</span>$<span class="fu"><a href="../reference/model-method-compile.html">compile</a></span>()</pre></body></html></div>
<pre><code>Compiling Stan program...</code></pre>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">mod</span>$<span class="fu">exe_file</span>()</pre></body></html></div>
<pre><code>[1] "/Users/jgabry/.cmdstanr/cmdstan-2.23.0/examples/bernoulli/bernoulli"</code></pre>
<p>In all cases the executable is created in the same directory as the file containing the Stan program.</p>
</div>
</div>
<div id="processing-data" class="section level2">
<h2 class="hasAnchor">
<a href="#processing-data" class="anchor"></a>Processing data</h2>
<p>There are three data formats that CmdStanR allows when fitting a model:</p>
<ul>
<li>named list of R objects</li>
<li>JSON file</li>
<li>R dump file</li>
</ul>
<div id="named-list-of-r-objects" class="section level3">
<h3 class="hasAnchor">
<a href="#named-list-of-r-objects" class="anchor"></a>Named list of R objects</h3>
<p>Like the RStan interface, CmdStanR accepts a named list of R objects where the names correspond to variables declared in the <code>data</code> block of the Stan program:</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="co"># data block has 'N' and 'y'</span>
<span class="no">data_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">N</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>))
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="no">mod</span>$<span class="fu"><a href="../reference/model-method-sample.html">sample</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">data_list</span>)</pre></body></html></div>
<p>Because CmdStan doesn’t accept lists of R objects, CmdStanR will first write the data to a temporary JSON file using <code><a href="../reference/write_stan_json.html">write_stan_json()</a></code>. This happens internally, but it is also possible to call <code><a href="../reference/write_stan_json.html">write_stan_json()</a></code> directly:</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">data_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">N</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>))
<span class="no">json_file</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span>(<span class="kw">fileext</span> <span class="kw">=</span> <span class="st">".json"</span>)
<span class="fu"><a href="../reference/write_stan_json.html">write_stan_json</a></span>(<span class="no">data_list</span>, <span class="no">json_file</span>)
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="no">json_file</span>), <span class="kw">sep</span> <span class="kw">=</span> <span class="st">"\n"</span>)</pre></body></html></div>
<pre><code>{
  "N": 10,
  "y": [0, 1, 0, 0, 0, 0, 0, 0, 0, 1]
}</code></pre>
</div>
<div id="json-file" class="section level3">
<h3 class="hasAnchor">
<a href="#json-file" class="anchor"></a>JSON file</h3>
<p>If you already have your data in a JSON file you can just pass that file directly to CmdStanR instead of using a list of R objects. For example, we could pass in the JSON file we created above using <code><a href="../reference/write_stan_json.html">write_stan_json()</a></code>:</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">&lt;-</span> <span class="no">mod</span>$<span class="fu"><a href="../reference/model-method-sample.html">sample</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">json_file</span>)</pre></body></html></div>
</div>
<div id="r-dump-file" class="section level3">
<h3 class="hasAnchor">
<a href="#r-dump-file" class="anchor"></a>R dump file</h3>
<p>Finally, it is also possible to use the R dump file format. This is <em>not</em> recommended because CmdStan can process JSON faster than R dump, but CmdStanR allows it because CmdStan will accept files created by <code><a href="https://rdrr.io/pkg/rstan/man/stan_rdump.html">rstan::stan_rdump()</a></code>:</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">rdump_file</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span>(<span class="kw">fileext</span> <span class="kw">=</span> <span class="st">".data.R"</span>)
<span class="kw pkg">rstan</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/rstan/man/stan_rdump.html">stan_rdump</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">data_list</span>), <span class="kw">file</span> <span class="kw">=</span> <span class="no">rdump_file</span>, <span class="kw">envir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list2env.html">list2env</a></span>(<span class="no">data_list</span>))
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="no">rdump_file</span>), <span class="kw">sep</span> <span class="kw">=</span> <span class="st">"\n"</span>)
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="no">mod</span>$<span class="fu"><a href="../reference/model-method-sample.html">sample</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">rdump_file</span>)</pre></body></html></div>
</div>
</div>
<div id="writing-cmdstan-output-to-csv" class="section level2">
<h2 class="hasAnchor">
<a href="#writing-cmdstan-output-to-csv" class="anchor"></a>Writing CmdStan output to CSV</h2>
<div id="default-temporary-files" class="section level3">
<h3 class="hasAnchor">
<a href="#default-temporary-files" class="anchor"></a>Default temporary files</h3>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">data_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">N</span> <span class="kw">=</span> <span class="fl">10</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span>))
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="no">mod</span>$<span class="fu"><a href="../reference/model-method-sample.html">sample</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">data_list</span>)</pre></body></html></div>
<p>When fitting a model, the default behavior is to write the output from CmdStan to CSV files in a temporary directory:</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">fit</span>$<span class="fu"><a href="../reference/fit-method-save_output_files.html">output_files</a></span>()</pre></body></html></div>
<pre><code>[1] "/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-202006231743-1-9a44ba.csv"
[2] "/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-202006231743-2-9a44ba.csv"
[3] "/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-202006231743-3-9a44ba.csv"
[4] "/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-202006231743-4-9a44ba.csv"</code></pre>
<p>These files will be lost if you end your R session or if you remove the <code>fit</code> object and force (or wait for) garbage collection.</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="no">files</span> <span class="kw">&lt;-</span> <span class="no">fit</span>$<span class="fu"><a href="../reference/fit-method-save_output_files.html">output_files</a></span>()
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="no">files</span>)</pre></body></html></div>
<pre><code>[1] TRUE TRUE TRUE TRUE</code></pre>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">fit</span>)
<span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span>()</pre></body></html></div>
<pre><code>          used (Mb) gc trigger (Mb) limit (Mb) max used (Mb)
Ncells  913858 48.9    1821475 97.3         NA  1245481 66.6
Vcells 1678927 12.9    8388608 64.0      16384  2517288 19.3</code></pre>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="no">files</span>)</pre></body></html></div>
<pre><code>[1] FALSE FALSE FALSE FALSE</code></pre>
</div>
<div id="non-temporary-files" class="section level3">
<h3 class="hasAnchor">
<a href="#non-temporary-files" class="anchor"></a>Non-temporary files</h3>
<p>To save these files to a non-temporary location there are two options. You can either specify the <code>output_dir</code> argument to <code>mod$sample()</code> or use <code>fit$save_output_files()</code> after fitting the model:</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="co"># see ?save_output_files for info on optional arguments</span>
<span class="no">fit</span>$<span class="fu"><a href="../reference/fit-method-save_output_files.html">save_output_files</a></span>(<span class="kw">dir</span> <span class="kw">=</span> <span class="st">"path/to/directory"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">&lt;-</span> <span class="no">mod</span>$<span class="fu"><a href="../reference/model-method-sample.html">sample</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">data_list</span>,
  <span class="kw">output_dir</span> <span class="kw">=</span> <span class="st">"path/to/directory"</span>
)</pre></body></html></div>
</div>
</div>
<div id="reading-cmdstan-output-into-r" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-cmdstan-output-into-r" class="anchor"></a>Reading CmdStan output into R</h2>
<div id="lazy-csv-reading" class="section level3">
<h3 class="hasAnchor">
<a href="#lazy-csv-reading" class="anchor"></a>Lazy CSV reading</h3>
<p>With the exception of some diagnostic information, the CSV files are not read into R until their contents are requested by calling a method that requires them (e.g., <code>fit$draws()</code>, <code>fit$summary()</code>, etc.). If we examine the structure of the <code>fit</code> object, notice how the <code>Private</code> slot <code>draws_</code> is <code>NULL</code>, indicating that the CSV files haven’t yet been read into R:</p>
<div class="sourceCode" id="cb35"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<pre><code>Classes 'CmdStanMCMC', 'CmdStanFit', 'R6' &lt;CmdStanMCMC&gt;
  Inherits from: &lt;CmdStanFit&gt;
  Public:
    clone: function (deep = FALSE) 
    cmdstan_diagnose: function (...) 
    cmdstan_summary: function (...) 
    data_file: function () 
    draws: function (variables = NULL, inc_warmup = FALSE) 
    initialize: function (runset) 
    inv_metric: function (matrix = TRUE) 
    latent_dynamics_files: function (include_failed = FALSE) 
    lp: function () 
    num_chains: function () 
    num_procs: function () 
    output: function (id = NULL) 
    output_files: function (include_failed = FALSE) 
    print: function (variables = NULL, ..., digits = 2, max_rows = 10) 
    runset: CmdStanRun, R6
    sampler_diagnostics: function (inc_warmup = FALSE) 
    sampling_info: function () 
    save_data_file: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
    save_latent_dynamics_files: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
    save_object: function (file, ...) 
    save_output_files: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
    summary: function (variables = NULL, ...) 
    time: function () 
  Private:
    draws_: NULL
    inv_metric_: NULL
    read_csv_: function (variables = NULL, sampler_diagnostics = NULL) 
    sampler_diagnostics_: NULL
    sampling_info_: NULL
    warmup_draws_: NULL
    warmup_sampler_diagnostics_: NULL </code></pre>
<p>After we call a method that requires the draws then if we reexamine the structure of the object we will see that the <code>draws_</code> slot in <code>Private</code> is no longer empty:</p>
<div class="sourceCode" id="cb37"><html><body><pre class="r"><span class="no">draws</span> <span class="kw">&lt;-</span> <span class="no">fit</span>$<span class="fu"><a href="../reference/fit-method-draws.html">draws</a></span>() <span class="co"># force CSVs to be read into R</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<pre><code>Classes 'CmdStanMCMC', 'CmdStanFit', 'R6' &lt;CmdStanMCMC&gt;
  Inherits from: &lt;CmdStanFit&gt;
  Public:
    clone: function (deep = FALSE) 
    cmdstan_diagnose: function (...) 
    cmdstan_summary: function (...) 
    data_file: function () 
    draws: function (variables = NULL, inc_warmup = FALSE) 
    initialize: function (runset) 
    inv_metric: function (matrix = TRUE) 
    latent_dynamics_files: function (include_failed = FALSE) 
    lp: function () 
    num_chains: function () 
    num_procs: function () 
    output: function (id = NULL) 
    output_files: function (include_failed = FALSE) 
    print: function (variables = NULL, ..., digits = 2, max_rows = 10) 
    runset: CmdStanRun, R6
    sampler_diagnostics: function (inc_warmup = FALSE) 
    sampling_info: function () 
    save_data_file: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
    save_latent_dynamics_files: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
    save_object: function (file, ...) 
    save_output_files: function (dir = ".", basename = NULL, timestamp = TRUE, random = TRUE) 
    summary: function (variables = NULL, ...) 
    time: function () 
  Private:
    draws_: -8.54695 -6.76065 -7.09215 -6.76343 -6.76772 -6.75266 -7 ...
    inv_metric_: list
    read_csv_: function (variables = NULL, sampler_diagnostics = NULL) 
    sampler_diagnostics_: NULL
    sampling_info_: list
    warmup_draws_: NULL
    warmup_sampler_diagnostics_: NULL </code></pre>
<p>For models with many parameters, transformed parameters, or generated quantities, if only some are requested (e.g., by specifying the <code>variables</code> argument to <code>fit$draws()</code>) then CmdStanR will only read in the requested variables (unless they have already been read in).</p>
</div>
<div id="saving-fitted-model-objects" class="section level3">
<h3 class="hasAnchor">
<a href="#saving-fitted-model-objects" class="anchor"></a>Saving fitted model objects</h3>
<p>Because the contents of the CSV files are only read into R when they are needed, in order to save a fitted model object containing <em>all</em> of the posterior draws and sampler diagnostics you should either make sure to call <code>fit$draws()</code> and <code>fit$sampler_diagnostics()</code> before saving the object <code>fit</code>, or use the special <code>$save_object()</code> method provided by CmdStanR, which will ensure that everything has been read into R before saving the object using <code><a href="https://rdrr.io/r/base/readRDS.html">saveRDS()</a></code>:</p>
<div class="sourceCode" id="cb39"><html><body><pre class="r"><span class="no">temp_rds_file</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span>(<span class="kw">fileext</span> <span class="kw">=</span> <span class="st">".RDS"</span>) <span class="co"># temporary file just for demonstration</span>
<span class="no">fit</span>$<span class="fu"><a href="../reference/fit-method-save_object.html">save_object</a></span>(<span class="kw">file</span> <span class="kw">=</span> <span class="no">temp_rds_file</span>)</pre></body></html></div>
<p>We can check that this worked by removing <code>fit</code> and loading it back in from the save file:</p>
<div class="sourceCode" id="cb40"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">fit</span>)
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="no">temp_rds_file</span>)
<span class="no">fit</span>$<span class="fu"><a href="../reference/fit-method-summary.html">summary</a></span>()</pre></body></html></div>
<pre><code># A tibble: 2 x 10
  variable   mean median    sd   mad      q5    q95  rhat ess_bulk ess_tail
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 lp__     -7.30  -7.03  0.763 0.376 -8.80   -6.75   1.00    1677.    1978.
2 theta     0.250  0.234 0.123 0.128  0.0783  0.474  1.00    1391.    1756.</code></pre>
</div>
<div id="read_sample_csv" class="section level3">
<h3 class="hasAnchor">
<a href="#read_sample_csv" class="anchor"></a>read_sample_csv()</h3>
<p>Internally, the <code><a href="../reference/read_sample_csv.html">read_sample_csv()</a></code> function is used to read the CmdStan CSV files into R. This function is exposed to users, so you can also call it directly:</p>
<div class="sourceCode" id="cb42"><html><body><pre class="r"><span class="co"># see ?read_sample_csv for info on optional arguments controlling </span>
<span class="co"># what information is read in</span>
<span class="no">csv_contents</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/read_sample_csv.html">read_sample_csv</a></span>(<span class="no">fit</span>$<span class="fu"><a href="../reference/fit-method-save_output_files.html">output_files</a></span>())
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">csv_contents</span>)</pre></body></html></div>
<pre><code>List of 7
 $ sampling_info                  :List of 31
  ..$ stan_version_major : num 2
  ..$ stan_version_minor : num 23
  ..$ stan_version_patch : num 0
  ..$ method             : chr "sample"
  ..$ save_warmup        : num 0
  ..$ thin               : num 1
  ..$ gamma              : num 0.05
  ..$ kappa              : num 0.75
  ..$ t0                 : num 10
  ..$ init_buffer        : num 75
  ..$ term_buffer        : num 50
  ..$ window             : num 25
  ..$ algorithm          : chr "hmc"
  ..$ engine             : chr "nuts"
  ..$ metric             : chr "diag_e"
  ..$ stepsize_jitter    : num 0
  ..$ id                 : num [1:4] 1 2 3 4
  ..$ init               : num 2
  ..$ seed               : num [1:4] 4.40e+08 1.22e+09 1.30e+09 6.87e+08
  ..$ refresh            : num 100
  ..$ model_params       : chr [1:2] "lp__" "theta"
  ..$ sampler_diagnostics: chr [1:6] "accept_stat__" "stepsize__" "treedepth__" "n_leapfrog__" ...
  ..$ stepsize_adaptation: num 1
  ..$ model_name         : chr "bernoulli_model"
  ..$ adapt_engaged      : num 1
  ..$ adapt_delta        : num 0.8
  ..$ max_treedepth      : num 10
  ..$ step_size          : num 1
  ..$ iter_warmup        : num 1000
  ..$ iter_sampling      : num 1000
  ..$ lines_to_skip      : num 38
 $ inv_metric                     :List of 4
  ..$ : num 0.466
  ..$ : num 0.54
  ..$ : num 0.485
  ..$ : num 0.498
 $ step_size                      :List of 4
  ..$ : num 1
  ..$ : num 0.75
  ..$ : num 1.01
  ..$ : num 1.03
 $ warmup_draws                   : NULL
 $ post_warmup_draws              : 'draws_array' num [1:1000, 1:4, 1:2] -8.55 -6.76 -7.09 -6.76 -6.77 ...
  ..- attr(*, "dimnames")=List of 3
  .. ..$ iteration: chr [1:1000] "1" "2" "3" "4" ...
  .. ..$ chain    : chr [1:4] "1" "2" "3" "4"
  .. ..$ variable : chr [1:2] "lp__" "theta"
 $ warmup_sampler_diagnostics     : NULL
 $ post_warmup_sampler_diagnostics: 'draws_array' num [1:1000, 1:4, 1:6] 0.738 0.878 0.95 0.99 0.996 ...
  ..- attr(*, "dimnames")=List of 3
  .. ..$ iteration: chr [1:1000] "1" "2" "3" "4" ...
  .. ..$ chain    : chr [1:4] "1" "2" "3" "4"
  .. ..$ variable : chr [1:6] "accept_stat__" "stepsize__" "treedepth__" "n_leapfrog__" ...</code></pre>
</div>
<div id="saving-and-accessing-advanced-algorithm-info-latent-dynamics" class="section level3">
<h3 class="hasAnchor">
<a href="#saving-and-accessing-advanced-algorithm-info-latent-dynamics" class="anchor"></a>Saving and accessing advanced algorithm info (latent dynamics)</h3>
<p>If <code>save_latent_dynamics</code> is set to <code>TRUE</code> when running the <code>$sample()</code> method then additional CSV files are created (one per chain) that provide access to quantities used under the hood by Stan’s implementation of dynamic Hamiltonian Monte Carlo.</p>
<p>CmdStanR does not yet provide a special method for processing these files but they can be read into R using R’s standard CSV reading functions:</p>
<div class="sourceCode" id="cb44"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">&lt;-</span> <span class="no">mod</span>$<span class="fu"><a href="../reference/model-method-sample.html">sample</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">data_list</span>, <span class="kw">save_latent_dynamics</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<div class="sourceCode" id="cb45"><html><body><pre class="r"><span class="no">fit</span>$<span class="fu"><a href="../reference/fit-method-save_output_files.html">latent_dynamics_files</a></span>()</pre></body></html></div>
<pre><code>[1] "/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-diagnostic-202006231743-1-92bc63.csv"
[2] "/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-diagnostic-202006231743-2-92bc63.csv"
[3] "/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-diagnostic-202006231743-3-92bc63.csv"
[4] "/var/folders/h6/14xy_35x4wd2tz542dn0qhtc0000gn/T/RtmplaARek/bernoulli-diagnostic-202006231743-4-92bc63.csv"</code></pre>
<div class="sourceCode" id="cb47"><html><body><pre class="r"><span class="co"># read one of the files in</span>
<span class="no">x</span> <span class="kw">&lt;-</span> <span class="kw pkg">utils</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="no">fit</span>$<span class="fu"><a href="../reference/fit-method-save_output_files.html">latent_dynamics_files</a></span>()[<span class="fl">1</span>], <span class="kw">comment.char</span> <span class="kw">=</span> <span class="st">"#"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>)</pre></body></html></div>
<pre><code>      lp__ accept_stat__ stepsize__ treedepth__ n_leapfrog__ divergent__
1 -8.16957      0.684702     1.1014           1            1           0
2 -7.21336      1.000000     1.1014           2            3           0
3 -6.84419      0.982612     1.1014           2            3           0
4 -7.05866      0.951315     1.1014           1            1           0
5 -8.62239      0.865112     1.1014           2            3           0
6 -6.74832      1.000000     1.1014           1            3           0
  energy__      theta    p_theta    g_theta
1  8.23835 -0.0506837 -0.5687600  2.8479800
2  7.95764 -1.7825900  1.8709300 -1.2722000
3  7.39741 -1.3986900  1.6130000 -0.6237160
4  7.05920 -1.6505300  0.0502225 -1.0675500
5  9.15094  0.0968538 -1.5766300  3.2903300
6  8.14955 -1.1149900 -2.5671000 -0.0367046</code></pre>
<p>The column <code>lp__</code> is also provided via <code>fit$draws()</code>, and the columns <code>accept_stat__</code>, <code>stepsize__</code>, <code>treedepth__</code>, <code>n_leapfrog__</code>, <code>divergent__</code>, and <code>energy__</code> are also provided by <code>fit$sampler_diagnostics()</code>, but there are several columns unique to the latent dynamics file:</p>
<div class="sourceCode" id="cb49"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">x</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"theta"</span>, <span class="st">"p_theta"</span>, <span class="st">"g_theta"</span>)])</pre></body></html></div>
<pre><code>       theta    p_theta    g_theta
1 -0.0506837 -0.5687600  2.8479800
2 -1.7825900  1.8709300 -1.2722000
3 -1.3986900  1.6130000 -0.6237160
4 -1.6505300  0.0502225 -1.0675500
5  0.0968538 -1.5766300  3.2903300
6 -1.1149900 -2.5671000 -0.0367046</code></pre>
<p>Our model has a single parameter <code>theta</code> and the three columns above correspond to <code>theta</code> in the <em>unconstrained</em> space (<code>theta</code> on the constrained space is accessed via <code>fit$draws()</code>), the auxiliary momentum <code>p_theta</code>, and the gradient <code>g_theta</code>. In general, each of these three columns will exist for <em>every</em> parameter in the model.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonah Gabry, Rok Češnovar.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
